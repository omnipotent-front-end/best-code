<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx | 编码技巧</title>
    <meta name="description" content="编码技巧集合">
    <link rel="stylesheet" href="/best-code/assets/style.c3210e46.css">
    <link rel="modulepreload" href="/best-code/assets/app.a8980bfd.js">
    <link rel="modulepreload" href="/best-code/assets/linux_usage_nginx.md.e4e0915f.lean.js">
    
    <meta name="twitter:title" content="Nginx | 编码技巧">
  <meta property="og:title" content="Nginx | 编码技巧">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/best-code/" aria-label="编码技巧, back to home" data-v-675d8756 data-v-cc01ef16><!----> 编码技巧</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/html/" data-v-b8818f8c>html <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/javascript/" data-v-b8818f8c>javascript <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/node/" data-v-b8818f8c>node <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/css/" data-v-b8818f8c>css <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/react/" data-v-b8818f8c>react <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/vue/" data-v-b8818f8c>vue <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/go/" data-v-b8818f8c>go <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/java/" data-v-b8818f8c>java <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/best-code/linux/" data-v-b8818f8c>linux <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://brizer.github.io/urls/zh/api.html" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>三方库 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>知识库 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/-Design-Patterns-Typescript/#/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>设计模式 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/Foods/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>健康指南 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/omnipotent-front-end/best-code" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/html/" data-v-b8818f8c>html <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/javascript/" data-v-b8818f8c>javascript <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/node/" data-v-b8818f8c>node <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/css/" data-v-b8818f8c>css <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/react/" data-v-b8818f8c>react <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/vue/" data-v-b8818f8c>vue <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/go/" data-v-b8818f8c>go <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/best-code/java/" data-v-b8818f8c>java <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/best-code/linux/" data-v-b8818f8c>linux <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://brizer.github.io/urls/zh/api.html" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>三方库 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>知识库 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/-Design-Patterns-Typescript/#/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>设计模式 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://omnipotent-front-end.github.io/Foods/" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>健康指南 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/omnipotent-front-end/best-code" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><p class="sidebar-link-item">使用</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/best-code/linux/usage/file">文件相关</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/best-code/linux/usage/network">网络相关</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/best-code/linux/usage/nginx">Nginx</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#配置大全">配置大全</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#location详解">Location详解</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#history路由404">history路由404</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#跨域问题">跨域问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#gzip压缩">gzip压缩</a><!----></li></ul></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="nginx" tabindex="-1">Nginx <a class="header-anchor" href="#nginx" aria-hidden="true">#</a></h1><h2 id="配置大全" tabindex="-1">配置大全 <a class="header-anchor" href="#配置大全" aria-hidden="true">#</a></h2><div class="language-nginx"><pre><code><span class="token comment"># 启动进程,通常设置成和cpu的数量相等</span>
<span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">1</span></span><span class="token punctuation">;</span>

<span class="token comment"># 全局错误日志定义类型，[debug | info | notice | warn | error | crit]</span>
<span class="token directive"><span class="token keyword">error_log</span>  logs/error.log</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span>  logs/error.log  notice</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span>  logs/error.log  info</span><span class="token punctuation">;</span>

<span class="token comment"># 进程pid文件</span>
<span class="token directive"><span class="token keyword">pid</span>        /var/run/nginx.pid</span><span class="token punctuation">;</span>

<span class="token comment"># 工作模式及连接数上限</span>
<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>
    <span class="token comment"># 仅用于linux2.6以上内核,可以大大提高nginx的性能</span>
    <span class="token directive"><span class="token keyword">use</span>   epoll</span><span class="token punctuation">;</span>

    <span class="token comment"># 单个后台worker process进程的最大并发链接数</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 客户端请求头部的缓冲区大小</span>
    <span class="token directive"><span class="token keyword">client_header_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span>

    <span class="token comment"># keepalive 超时时间</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">60</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 告诉nginx收到一个新连接通知后接受尽可能多的连接</span>
    <span class="token comment"># multi_accept on;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 设定http服务器，利用它的反向代理功能提供负载均衡支持</span>
<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token comment"># 文件扩展名与文件类型映射表义</span>
    <span class="token directive"><span class="token keyword">include</span>       /etc/nginx/mime.types</span><span class="token punctuation">;</span>

    <span class="token comment"># 默认文件类型</span>
    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token comment"># 默认编码</span>
    <span class="token directive"><span class="token keyword">charset</span> utf-8</span><span class="token punctuation">;</span>

    <span class="token comment"># 服务器名字的hash表大小</span>
    <span class="token directive"><span class="token keyword">server_names_hash_bucket_size</span> <span class="token number">128</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 客户端请求头部的缓冲区大小</span>
    <span class="token directive"><span class="token keyword">client_header_buffer_size</span> <span class="token number">32k</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 客户请求头缓冲大小</span>
    <span class="token directive"><span class="token keyword">large_client_header_buffers</span> <span class="token number">4</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 设定通过nginx上传文件的大小</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">8m</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 开启目录列表访问，合适下载服务器，默认关闭。</span>
    <span class="token directive"><span class="token keyword">autoindex</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token comment"># sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，</span>
    <span class="token comment"># 必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度</span>
    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 此选项允许或禁止使用socke的TCP_CORK的选项，此选项仅在使用sendfile的时候使用</span>
    <span class="token comment">#tcp_nopush     on;</span>

    <span class="token comment"># 连接超时时间（单秒为秒）</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>


    <span class="token comment"># gzip模块设置</span>
    <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>               <span class="token comment">#开启gzip压缩输出</span>
    <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span>    <span class="token comment">#最小压缩文件大小</span>
    <span class="token directive"><span class="token keyword">gzip_buffers</span> <span class="token number">4</span> <span class="token number">16k</span></span><span class="token punctuation">;</span>    <span class="token comment">#压缩缓冲区</span>
    <span class="token directive"><span class="token keyword">gzip_http_version</span> 1.0</span><span class="token punctuation">;</span> <span class="token comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span>
    <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">2</span></span><span class="token punctuation">;</span>     <span class="token comment">#压缩等级</span>
    <span class="token directive"><span class="token keyword">gzip_types</span> text/plain application/x-javascript text/css application/xml</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 开启限制IP连接数的时候需要使用</span>
    <span class="token comment">#limit_zone crawler $binary_remote_addr 10m;</span>

    <span class="token comment"># 指定虚拟主机的配置文件，方便管理</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>


    <span class="token comment"># 负载均衡配置</span>
    <span class="token directive"><span class="token keyword">upstream</span> aaa</span> <span class="token punctuation">{</span>
        <span class="token comment"># 请见上文中的五种配置</span>
    <span class="token punctuation">}</span>


   <span class="token comment"># 虚拟主机的配置</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>

        <span class="token comment"># 监听端口</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>

        <span class="token comment"># 域名可以有多个，用空格隔开</span>
        <span class="token directive"><span class="token keyword">server_name</span> www.aaa.com aaa.com</span><span class="token punctuation">;</span>

        <span class="token comment"># 默认入口文件名称</span>
        <span class="token directive"><span class="token keyword">index</span> index.html index.htm index.php</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">root</span> /data/www/sk</span><span class="token punctuation">;</span>

        <span class="token comment"># 图片缓存时间设置</span>
        <span class="token directive"><span class="token keyword">location</span> ~ .*.(gif|jpg|jpeg|png|bmp|swf)$</span><span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">expires</span> <span class="token number">10d</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">#JS和CSS缓存时间设置</span>
        <span class="token directive"><span class="token keyword">location</span> ~ .*.(js|css)?$</span><span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">expires</span> <span class="token number">1h</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># 日志格式设定</span>
        <span class="token comment">#$remote_addr与 $http_x_forwarded_for用以记录客户端的ip地址；</span>
        <span class="token comment">#$remote_user：用来记录客户端用户名称；</span>
        <span class="token comment">#$time_local：用来记录访问时间与时区；</span>
        <span class="token comment">#$request：用来记录请求的url与http协议；</span>
        <span class="token comment">#$status：用来记录请求状态；成功是200，</span>
        <span class="token comment">#$body_bytes_sent ：记录发送给客户端文件主体内容大小；</span>
        <span class="token comment">#$http_referer：用来记录从那个页面链接访问过来的；</span>
        <span class="token directive"><span class="token keyword">log_format</span> access <span class="token string">&#39;<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> &quot;<span class="token variable">$request</span>&quot; &#39;</span>
        <span class="token string">&#39;<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> &quot;<span class="token variable">$http_referer</span>&quot; &#39;</span>
        <span class="token string">&#39;&quot;<span class="token variable">$http_user_agent</span>&quot; <span class="token variable">$http_x_forwarded_for</span>&#39;</span></span><span class="token punctuation">;</span>

        <span class="token comment"># 定义本虚拟主机的访问日志</span>
        <span class="token directive"><span class="token keyword">access_log</span>  /usr/local/nginx/logs/host.access.log  main</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span>  /usr/local/nginx/logs/host.access.404.log  log404</span><span class="token punctuation">;</span>

        <span class="token comment"># 对具体路由进行反向代理</span>
        <span class="token directive"><span class="token keyword">location</span> /connect-controller</span> <span class="token punctuation">{</span>

            <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:88</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 允许客户端请求的最大单文件字节数</span>
            <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 缓冲区代理缓冲用户端请求的最大字节数，</span>
            <span class="token directive"><span class="token keyword">client_body_buffer_size</span> <span class="token number">128k</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 表示使nginx阻止HTTP应答代码为400或者更高的应答。</span>
            <span class="token directive"><span class="token keyword">proxy_intercept_errors</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

            <span class="token comment"># nginx跟后端服务器连接超时时间(代理连接超时)</span>
            <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据</span>
            <span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 连接成功后，后端服务器响应的超时时间</span>
            <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">90</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
            <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 设置用于读取应答的缓冲区数目和大小，默认情况也为分页大小，根据操作系统的不同可能是4k或者8k</span>
            <span class="token directive"><span class="token keyword">proxy_buffers</span> <span class="token number">4</span> <span class="token number">32k</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 高负荷下缓冲大小（proxy_buffers*2）</span>
            <span class="token directive"><span class="token keyword">proxy_busy_buffers_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>

            <span class="token comment"># 设置在写入proxy_temp_path时数据的大小，预防一个工作进程在传递文件时阻塞太长</span>
            <span class="token comment"># 设定缓存文件夹大小，大于这个值，将从upstream服务器传</span>
            <span class="token directive"><span class="token keyword">proxy_temp_file_write_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># 动静分离反向代理配置（多路由指向不同的服务端或界面）</span>
        <span class="token directive"><span class="token keyword">location</span> ~ .(jsp|jspx|do)?$</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8080</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="location详解" tabindex="-1">Location详解 <a class="header-anchor" href="#location详解" aria-hidden="true">#</a></h2><p css-module=".">location [ = | ~ | ~* | ^~ ] uri </p><p>[ = | ~ | ~* | ^~ ]：匹配的标识</p><p>~与~*的区别是：~区分大小写，~*不区分大小写</p><p>^~：进行常规字符串匹配后，不做正则表达式的检查</p><p>uri：匹配的网站地址</p><p>{...}：匹配uri后要执行的配置段</p><p>举例：</p><div class="language-nginx"><pre><code><span class="token directive"><span class="token keyword">location</span> = /</span> <span class="token punctuation">{</span>
    [ configuration A ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    [ configuration B ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> /sk/</span> <span class="token punctuation">{</span>
    [ configuration C ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ^~ /img/</span> <span class="token punctuation">{</span>
    [ configuration D ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~* .(gif|jpg|jpeg)$</span> <span class="token punctuation">{</span>
    [ configuration E ]
<span class="token punctuation">}</span>
</code></pre></div><p>= / 请求 / 精准匹配A，不再往下查找</p><p>/ 请求/index.html匹配B。首先查找匹配的前缀字符，找到最长匹配是配置B，接着又按照顺序查找匹配的正则。结果没有找到，因此使用先前标记的最长匹配，即配置B。</p><p>/sk/ 请求/sk/abc 匹配C。首先找到最长匹配C，由于后面没有匹配的正则，所以使用最长匹配C。</p><p>~* .(gif|jpg|jpeg)$ 请求/sk/logo.gif 匹配E。首先进行前缀字符的查找，找到最长匹配项C，继续进行正则查找，找到匹配项E。因此使用E。</p><p>^~ 请求/img/logo.gif匹配D。首先进行前缀字符查找，找到最长匹配D。但是它使用了^~修饰符，不再进行下面的正则的匹配查找，因此使用D。</p><h2 id="history路由404" tabindex="-1">history路由404 <a class="header-anchor" href="#history路由404" aria-hidden="true">#</a></h2><div class="language-nginx"><pre><code>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="跨域问题" tabindex="-1">跨域问题 <a class="header-anchor" href="#跨域问题" aria-hidden="true">#</a></h2><div class="language-nginx"><pre><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>   <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token comment"># 服务器默认是不被允许跨域的。</span>
        <span class="token comment"># 配置`*`后，表示服务器可以接受所有的请求源（Origin）,即接受所有跨域的请求</span>
        <span class="token directive"><span class="token keyword">add_header</span> Access-Control-Allow-Origin *</span><span class="token punctuation">;</span>
        
        <span class="token directive"><span class="token keyword">add_header</span> Access-Control-Allow-Methods <span class="token string">&#39;GET, POST, OPTIONS&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> Access-Control-Allow-Headers <span class="token string">&#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#39;</span></span><span class="token punctuation">;</span>
        
        <span class="token comment"># 发送&quot;预检请求&quot;时，需要用到方法 OPTIONS ,所以服务器需要允许该方法</span>
        <span class="token comment"># 给OPTIONS 添加 204的返回，是为了处理在发送POST请求时Nginx依然拒绝访问的错误</span>
        <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> = <span class="token string">&#39;OPTIONS&#39;</span>)</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">return</span> <span class="token number">204</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="gzip压缩" tabindex="-1">gzip压缩 <a class="header-anchor" href="#gzip压缩" aria-hidden="true">#</a></h2><div class="language-nginx"><pre><code>    <span class="token comment"># gzip模块设置</span>
    <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>               <span class="token comment">#开启gzip压缩输出</span>
    <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span>    <span class="token comment">#最小压缩文件大小</span>
    <span class="token directive"><span class="token keyword">gzip_buffers</span> <span class="token number">4</span> <span class="token number">16k</span></span><span class="token punctuation">;</span>    <span class="token comment">#压缩缓冲区</span>
    <span class="token directive"><span class="token keyword">gzip_http_version</span> 1.0</span><span class="token punctuation">;</span> <span class="token comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span>
    <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">2</span></span><span class="token punctuation">;</span>     <span class="token comment">#压缩等级</span>
    
    <span class="token comment"># 设置什么类型的文件需要压缩</span>
    <span class="token directive"><span class="token keyword">gzip_types</span> text/plain application/x-javascript text/css application/xml</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 用于设置使用Gzip进行压缩发送是否携带“Vary:Accept-Encoding”头域的响应头部</span>
    <span class="token comment"># 主要是告诉接收方，所发送的数据经过了Gzip压缩处理</span>
    <span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

</code></pre></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><!----></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/best-code/linux/usage/network" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>网络相关</span></a></div><div class="next" data-v-38ede35f><!----></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"css_animate.md\":\"5abc076d\",\"css_global.md\":\"03b0dda0\",\"css_index.md\":\"00d3a390\",\"css_scss.md\":\"3fd0c24e\",\"go_grammar_basic.md\":\"c42f707e\",\"go_grammar_better.md\":\"d7af1dbf\",\"go_index.md\":\"3f8765ad\",\"html_grammar_head.md\":\"928c9568\",\"html_index.md\":\"66095ff7\",\"index.md\":\"0ca068a4\",\"java_grammar_basic.md\":\"f064c45a\",\"java_index.md\":\"698bb0d9\",\"javascript_async_event.md\":\"946f86fd\",\"javascript_async_for.md\":\"41804474\",\"javascript_async_module.md\":\"222124e3\",\"javascript_async_then.md\":\"215638db\",\"javascript_clean_array.md\":\"fd9beb27\",\"javascript_clean_class.md\":\"cbe8b0e8\",\"javascript_clean_comment.md\":\"6b79a6f2\",\"javascript_clean_function.md\":\"865eaf25\",\"javascript_clean_object.md\":\"0c17f178\",\"javascript_clean_variable.md\":\"434f6123\",\"javascript_index.md\":\"e15ab524\",\"javascript_test_refer.md\":\"332891e8\",\"javascript_typescript_decorator.md\":\"69c76164\",\"javascript_util_array.md\":\"bbae5c5b\",\"javascript_util_date.md\":\"f5b1d721\",\"javascript_util_effect.md\":\"63f98682\",\"javascript_util_entry.md\":\"d1ff8a05\",\"javascript_util_function.md\":\"277100b1\",\"javascript_util_log.md\":\"9767b2f2\",\"javascript_util_number.md\":\"0fb2c411\",\"javascript_util_object.md\":\"9aea56c9\",\"javascript_util_string.md\":\"b41b2069\",\"javascript_util_type.md\":\"a2496b9a\",\"javascript_web_dom.md\":\"1ff4198f\",\"javascript_web_file.md\":\"7bede717\",\"javascript_web_index.md\":\"ed688b4b\",\"linux_index.md\":\"0dce85a2\",\"linux_usage_file.md\":\"f717be55\",\"linux_usage_network.md\":\"a0b96e3a\",\"linux_usage_nginx.md\":\"e4e0915f\",\"node_build_pack.md\":\"3b7549d6\",\"node_build_webpack.md\":\"7ca1cbe1\",\"node_cli_config.md\":\"e42dd6e8\",\"node_cli_pipe.md\":\"2731d30e\",\"node_cli_refer.md\":\"cf3088c1\",\"node_cli_ua.md\":\"84c943ef\",\"node_fs_fs.md\":\"72147d33\",\"node_index.md\":\"e6c66e46\",\"node_process_child_process.md\":\"3bf04f53\",\"node_process_worker_thread.md\":\"04ce6fd5\",\"react_grammar_jsx.md\":\"857b08c8\",\"react_index.md\":\"c12f8636\",\"vue_grammar_compositions.md\":\"59b11af9\",\"vue_grammar_jsx.md\":\"ce1b0404\",\"vue_grammar_sfc.md\":\"b30f8df9\",\"vue_index.md\":\"0c2f897d\"}")</script>
    <script type="module" async src="/best-code/assets/app.a8980bfd.js"></script>
    
  </body>
</html>